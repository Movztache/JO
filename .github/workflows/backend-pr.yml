# ============================================================================
# PIPELINE CI GITHUB ACTIONS - PULL REQUESTS BACKEND VIBE-TICKETS
# ============================================================================
#
# Ce pipeline s'exÃ©cute sur les Pull Requests pour valider les changements
# avant leur intÃ©gration dans la branche principale.
#
# OBJECTIFS :
# - Validation rapide des changements proposÃ©s
# - Tests de non-rÃ©gression
# - VÃ©rification de la qualitÃ© du code
# - Build et tests Docker sans dÃ©ploiement
# - Feedback rapide aux dÃ©veloppeurs
#
# DIFFÃ‰RENCES AVEC LE PIPELINE PRINCIPAL :
# - Pas de dÃ©ploiement AWS
# - Pas de push vers ECR
# - Focus sur la validation et les tests
# - ExÃ©cution plus rapide
#
# ============================================================================

name: ðŸ” Backend PR Validation

# ============================================================================
# CONFIGURATION DES DÃ‰CLENCHEURS
# ============================================================================
on:
  # DÃ©clenchement sur Pull Requests vers main
  pull_request:
    branches: 
      - main
      - develop
    # Filtrer uniquement les changements affectant le backend
    paths:
      - 'src/**'
      - 'pom.xml'
      - 'Dockerfile'
      - '.github/workflows/backend-*.yml'

  # DÃ©clenchement sur les mises Ã  jour de PR
  pull_request_target:
    types: [synchronize, reopened]
    branches: 
      - main
      - develop

# ============================================================================
# VARIABLES D'ENVIRONNEMENT
# ============================================================================
env:
  # Configuration Java et Maven
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx1024m -XX:MaxPermSize=256m'
  
  # Configuration Docker
  DOCKER_BUILDKIT: 1

# ============================================================================
# DÃ‰FINITION DES JOBS
# ============================================================================
jobs:
  # ==========================================================================
  # JOB 1: VALIDATION RAPIDE DU CODE
  # ==========================================================================
  quick-validation:
    name: âš¡ Validation Rapide
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------------------
      # Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout du code source
        uses: actions/checkout@v4
        with:
          # Pour les PR externes, utiliser le code de la PR
          ref: ${{ github.event.pull_request.head.sha }}

      # ----------------------------------------------------------------------
      # Ã‰TAPE 2: Configuration de Java
      # ----------------------------------------------------------------------
      - name: â˜• Configuration de Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'eclipse-temurin'

      # ----------------------------------------------------------------------
      # Ã‰TAPE 3: Cache Maven
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Cache des dÃ©pendances Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-pr-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-pr-
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # Ã‰TAPE 4: Validation et compilation rapide
      # ----------------------------------------------------------------------
      - name: ðŸ” Validation du projet
        run: |
          echo "ðŸ” Validation de la structure du projet..."
          mvn validate -q
          
          echo "ðŸ—ï¸ Compilation rapide..."
          mvn compile -B -q
          
          echo "âœ… Validation et compilation rÃ©ussies"

  # ==========================================================================
  # JOB 2: TESTS COMPLETS
  # ==========================================================================
  comprehensive-tests:
    name: ðŸ§ª Tests Complets
    runs-on: ubuntu-latest
    needs: quick-validation
    
    # Configuration des services pour les tests
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: vibe_tickets_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # ----------------------------------------------------------------------
      # Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout du code source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # ----------------------------------------------------------------------
      # Ã‰TAPE 2: Configuration de Java
      # ----------------------------------------------------------------------
      - name: â˜• Configuration de Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'eclipse-temurin'

      # ----------------------------------------------------------------------
      # Ã‰TAPE 3: Cache Maven
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Cache des dÃ©pendances Maven
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-pr-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-pr-
            ${{ runner.os }}-maven-

      # ----------------------------------------------------------------------
      # Ã‰TAPE 4: ExÃ©cution des tests
      # ----------------------------------------------------------------------
      - name: ðŸ§ª Tests unitaires et d'intÃ©gration
        run: |
          echo "ðŸ§ª ExÃ©cution de tous les tests..."
          mvn clean test -B
          
          echo "ðŸ“Š GÃ©nÃ©ration du rapport de couverture..."
          mvn jacoco:report
          
          echo "âœ… Tests terminÃ©s avec succÃ¨s"
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/vibe_tickets_test
          SPRING_DATASOURCE_USERNAME: test_user
          SPRING_DATASOURCE_PASSWORD: test_password

      # ----------------------------------------------------------------------
      # Ã‰TAPE 5: Analyse de la couverture de code
      # ----------------------------------------------------------------------
      - name: ðŸ“Š Analyse de la couverture de code
        run: |
          echo "ðŸ“Š Analyse de la couverture de code..."
          
          # VÃ©rification que le rapport existe
          if [ -f "target/site/jacoco/index.html" ]; then
            echo "âœ… Rapport de couverture gÃ©nÃ©rÃ©"
            
            # Extraction des mÃ©triques de couverture (si possible)
            if command -v xmllint &> /dev/null && [ -f "target/site/jacoco/jacoco.xml" ]; then
              COVERAGE=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@covered)" target/site/jacoco/jacoco.xml 2>/dev/null || echo "N/A")
              TOTAL=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@missed)" target/site/jacoco/jacoco.xml 2>/dev/null || echo "N/A")
              
              if [[ "$COVERAGE" != "N/A" && "$TOTAL" != "N/A" ]]; then
                PERCENTAGE=$(echo "scale=2; $COVERAGE / ($COVERAGE + $TOTAL) * 100" | bc -l 2>/dev/null || echo "N/A")
                echo "ðŸ“Š Couverture de code: ${PERCENTAGE}%"
              fi
            fi
          else
            echo "âš ï¸ Rapport de couverture non trouvÃ©"
          fi

      # ----------------------------------------------------------------------
      # Ã‰TAPE 6: Upload des rapports de tests
      # ----------------------------------------------------------------------
      - name: ðŸ“¤ Upload des rapports de tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: pr-test-reports-${{ github.event.pull_request.number }}
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 7

  # ==========================================================================
  # JOB 3: BUILD ET VALIDATION DOCKER
  # ==========================================================================
  docker-validation:
    name: ðŸ³ Validation Docker
    runs-on: ubuntu-latest
    needs: quick-validation

    steps:
      # ----------------------------------------------------------------------
      # Ã‰TAPE 1: RÃ©cupÃ©ration du code source
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout du code source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # ----------------------------------------------------------------------
      # Ã‰TAPE 2: Configuration de Java pour le build
      # ----------------------------------------------------------------------
      - name: â˜• Configuration de Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'eclipse-temurin'

      # ----------------------------------------------------------------------
      # Ã‰TAPE 3: Build de l'application
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Build de l'application
        run: |
          echo "ðŸ“¦ Build de l'application pour Docker..."
          mvn clean package -DskipTests -B -q
          
          echo "âœ… Build terminÃ©"

      # ----------------------------------------------------------------------
      # Ã‰TAPE 4: Configuration de Docker Buildx
      # ----------------------------------------------------------------------
      - name: ðŸ”§ Configuration de Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------------------------------------------------
      # Ã‰TAPE 5: Build et test de l'image Docker
      # ----------------------------------------------------------------------
      - name: ðŸ³ Build et test de l'image Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: vibe-tickets:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ----------------------------------------------------------------------
      # Ã‰TAPE 6: Test de l'image Docker
      # ----------------------------------------------------------------------
      - name: ðŸ§ª Test de l'image Docker
        run: |
          echo "ðŸ§ª Test de l'image Docker..."
          
          # DÃ©marrage du conteneur en mode test
          docker run -d --name test-container \
            -e SPRING_PROFILES_ACTIVE=test \
            -p 8080:8080 \
            vibe-tickets:pr-${{ github.event.pull_request.number }}
          
          # Attendre que l'application dÃ©marre
          echo "â³ Attente du dÃ©marrage de l'application..."
          for i in {1..12}; do
            if docker exec test-container curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… Application dÃ©marrÃ©e dans le conteneur"
              break
            fi
            
            if [ $i -eq 12 ]; then
              echo "âŒ L'application n'a pas dÃ©marrÃ© dans les temps"
              docker logs test-container
              exit 1
            fi
            
            sleep 5
          done
          
          # Nettoyage
          docker stop test-container
          docker rm test-container
          
          echo "âœ… Test Docker rÃ©ussi"

  # ==========================================================================
  # JOB 4: COMMENTAIRE DE RÃ‰SUMÃ‰ SUR LA PR
  # ==========================================================================
  pr-comment:
    name: ðŸ’¬ Commentaire PR
    runs-on: ubuntu-latest
    needs: [quick-validation, comprehensive-tests, docker-validation]
    if: always()

    steps:
      # ----------------------------------------------------------------------
      # Ã‰TAPE 1: PrÃ©paration du commentaire
      # ----------------------------------------------------------------------
      - name: ðŸ“ PrÃ©paration du commentaire PR
        id: comment
        run: |
          # DÃ©termination du statut global
          if [[ "${{ needs.quick-validation.result }}" == "success" && 
                "${{ needs.comprehensive-tests.result }}" == "success" && 
                "${{ needs.docker-validation.result }}" == "success" ]]; then
            STATUS="âœ… Tous les checks sont passÃ©s"
            EMOJI="ðŸŽ‰"
          else
            STATUS="âŒ Certains checks ont Ã©chouÃ©"
            EMOJI="âš ï¸"
          fi
          
          # Construction du commentaire
          cat > comment.md << EOF
          ## ${EMOJI} RÃ©sultat de la validation PR #${{ github.event.pull_request.number }}
          
          **Statut global**: ${STATUS}
          
          ### ðŸ“Š DÃ©tail des validations
          
          | Check | Statut | Description |
          |-------|--------|-------------|
          | Validation rapide | ${{ needs.quick-validation.result == 'success' && 'âœ… SuccÃ¨s' || 'âŒ Ã‰chec' }} | Compilation et validation de base |
          | Tests complets | ${{ needs.comprehensive-tests.result == 'success' && 'âœ… SuccÃ¨s' || 'âŒ Ã‰chec' }} | Tests unitaires et d'intÃ©gration |
          | Validation Docker | ${{ needs.docker-validation.result == 'success' && 'âœ… SuccÃ¨s' || 'âŒ Ã‰chec' }} | Build et test de l'image Docker |
          
          ### ðŸ”— Liens utiles
          - [DÃ©tails du workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Rapports de tests](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          
          ---
          *Validation automatique via GitHub Actions*
          EOF
          
          echo "comment-file=comment.md" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------------
      # Ã‰TAPE 2: Publication du commentaire
      # ----------------------------------------------------------------------
      - name: ðŸ’¬ Publication du commentaire PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('${{ steps.comment.outputs.comment-file }}', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# ============================================================================
# CONFIGURATION DES PERMISSIONS
# ============================================================================
permissions:
  contents: read
  pull-requests: write
  checks: write
